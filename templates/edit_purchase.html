{% extends "base.html" %}

{% block title %}编辑采购单 - 进销存管理系统{% endblock %}

{% block extra_css %}
<style>
    .product-row {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 15px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">编辑采购单</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('purchase.purchases') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 返回
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">采购单信息</h6>
            </div>
            <div class="card-body">
                <form method="POST" id="basic-info-form">
                    <input type="hidden" name="action" value="update_basic">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>采购单号：</strong>{{ purchase.order_no }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">供应商</label>
                            <select class="form-select" name="supplier_id" required>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}" {% if supplier.id==purchase.supplier_id %}selected{% endif %}>
                                    {{ supplier.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">采购员</label>
                            <input type="text" class="form-control" name="purchaser" value="{{ purchase.purchaser or '' }}">
                        </div>
                        <div class="col-md-3">
                            <strong>总金额：</strong>¥<span id="total-amount">{{ "%.2f"|format(purchase.total_amount) }}</span>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-9">
                            <label class="form-label">备注</label>
                            <textarea class="form-control" name="notes" rows="2">{{ purchase.notes or '' }}</textarea>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check"></i> 保存基本信息
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">商品明细</h6>
                <button type="button" class="btn btn-sm btn-primary" onclick="addProductRow()">
                    <i class="bi bi-plus"></i> 添加商品
                </button>
            </div>
            <div class="card-body">
                <form method="POST" id="purchase-form">
                    <input type="hidden" name="action" value="add_item">
                    <div id="product-list">
                        {% for item in items %}
                        <div class="product-row">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">商品</label>
                                    <select class="form-select product-select" name="product_id" required onchange="fillSuggestedPrice(this)">
                                        <option value="">请选择商品</option>
                                        {% for product in products %}
                                        <option value="{{ product.id }}" 
                                                data-suggested-price="{{ product.suggested_purchase_price or 0 }}"
                                                {% if product.id==item.product_id %}selected{% endif %}>
                                            {{ product.name }} ({{ product.unit }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">数量</label>
                                    <input type="number" class="form-control" name="quantity"
                                        value="{{ item.quantity }}" step="0.01" min="0" required
                                        onchange="calculateAmount(this)">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">单价</label>
                                    <input type="number" class="form-control" name="unit_price" value="{{ item.unit_price }}"
                                        step="0.01" min="0" required onchange="calculateAmount(this)">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">金额</label>
                                    <input type="number" class="form-control amount" value="{{ item.amount }}"
                                        readonly>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-danger"
                                        onclick="removeProductRow(this)">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        {% if not items %}
                        <div class="product-row">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">商品</label>
                                    <select class="form-select" name="product_id" required>
                                        <option value="">请选择商品</option>
                                        {% for product in products %}
                                        <option value="{{ product.id }}">{{ product.name }} ({{ product.unit }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">数量</label>
                                    <input type="number" class="form-control" name="quantity" step="0.01" min="0"
                                        required onchange="calculateAmount(this)">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">单价</label>
                                    <input type="number" class="form-control" name="unit_price" step="0.01" min="0" required
                                        onchange="calculateAmount(this)">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">金额</label>
                                    <input type="number" class="form-control amount" readonly>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-danger"
                                        onclick="removeProductRow(this)">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                        <a href="{{ url_for('purchase.purchases') }}" class="btn btn-secondary">
                            <i class="bi bi-x"></i> 取消
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check"></i> 保存采购单
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function addProductRow() {
        const productList = document.getElementById('product-list');
        const newRow = document.createElement('div');
        newRow.className = 'product-row';
        newRow.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">商品</label>
                <select class="form-select product-select" name="product_id" required onchange="fillSuggestedPrice(this)">
                    <option value="">请选择商品</option>
                    {% for product in products %}
                    <option value="{{ product.id }}" data-suggested-price="{{ product.suggested_purchase_price or 0 }}">{{ product.name }} ({{ product.unit }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">数量</label>
                <input type="number" class="form-control" name="quantity" 
                       step="0.01" min="0" required onchange="calculateAmount(this)">
            </div>
            <div class="col-md-2">
                <label class="form-label">单价</label>
                <input type="number" class="form-control" name="unit_price" 
                       step="0.01" min="0" required onchange="calculateAmount(this)">
            </div>
            <div class="col-md-2">
                <label class="form-label">金额</label>
                <input type="number" class="form-control amount" readonly>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger" onclick="removeProductRow(this)">
                    <i class="bi bi-trash"></i> 删除
                </button>
            </div>
        </div>
    `;
        productList.appendChild(newRow);
    }

    function removeProductRow(button) {
        const row = button.closest('.product-row');
        row.remove();
        calculateTotal();
    }

    function calculateAmount(input) {
        const row = input.closest('.product-row');
        const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
        const price = parseFloat(row.querySelector('input[name="unit_price"]').value) || 0;
        const amount = quantity * price;
        row.querySelector('.amount').value = amount.toFixed(2);
        calculateTotal();
    }

    function calculateTotal() {
        const amounts = document.querySelectorAll('.amount');
        let total = 0;
        amounts.forEach(amount => {
            total += parseFloat(amount.value) || 0;
        });
        document.getElementById('total-amount').textContent = total.toFixed(2);
    }

    function fillSuggestedPrice(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const suggestedPrice = selectedOption.dataset.suggestedPrice;
        const row = selectElement.closest('.product-row');
        const priceInput = row.querySelector('input[name="unit_price"]');
        
        if (suggestedPrice && parseFloat(suggestedPrice) > 0) {
            priceInput.value = suggestedPrice;
            calculateAmount(priceInput);
        }
    }

    // 页面加载时计算总金额
    document.addEventListener('DOMContentLoaded', function () {
        calculateTotal();
    });
</script>
{% endblock %}