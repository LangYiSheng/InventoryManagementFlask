{% extends "base.html" %}

{% block title %}编辑销售单{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>编辑销售单</h2>
                <a href="{{ url_for('sales.sales') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> 返回销售管理
                </a>
            </div>

            <!-- 销售单基本信息 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">销售单信息</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>销售单号：</strong> {{ sale.order_no }}
                        </div>
                        <div class="col-md-3">
                            <strong>客户：</strong> {{ customer.name }}
                        </div>
                        <div class="col-md-3">
                            <strong>总金额：</strong>
                            <span class="text-success fw-bold">¥<span id="total-amount">{{
                                    "%.2f"|format(sale.total_amount) }}</span></span>
                        </div>
                        <div class="col-md-3">
                            <strong>创建时间：</strong> {{ sale.created_at }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 商品明细 -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">商品明细</h5>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addProductRow()">
                        <i class="fas fa-plus"></i> 添加商品
                    </button>
                </div>
                <div class="card-body">
                    <form method="POST" id="sale-form">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="products-table">
                                <thead class="table-light">
                                    <tr>
                                        <th width="30%">商品</th>
                                        <th width="15%">数量</th>
                                        <th width="15%">单价</th>
                                        <th width="15%">金额</th>
                                        <th width="10%">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in sale_items %}
                                    <tr>
                                        <td>
                                            <select class="form-select product-select" name="product_id[]" required>
                                                <option value="">请选择商品</option>
                                                {% for product in products %}
                                                <option value="{{ product.id }}"
                                                    data-price="{{ product.suggested_sale_price or 0 }}" {{ 'selected'
                                                    if product.id==item.product_id }}>
                                                    {{ product.name }} ({{ product.specification or '无规格' }})
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control quantity-input" name="quantity[]"
                                                value="{{ item.quantity }}" min="1" step="1" required>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control price-input" name="unit_price[]"
                                                value="{{ item.unit_price }}" min="0" step="0.01" required>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control amount-input" name="amount[]"
                                                value="{{ item.amount }}" readonly>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-danger btn-sm"
                                                onclick="removeProductRow(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <strong>总金额：¥<span id="form-total">{{ "%.2f"|format(sale.total_amount)
                                        }}</span></strong>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('sales.sales') }}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> 取消
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> 保存销售单
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function addProductRow() {
        const tbody = document.querySelector('#products-table tbody');
        const newRow = document.createElement('tr');

        newRow.innerHTML = `
        <td>
            <select class="form-select product-select" name="product_id[]" required>
                <option value="">请选择商品</option>
                {% for product in products %}
                <option value="{{ product.id }}" data-price="{{ product.suggested_sale_price or 0 }}">
                    {{ product.name }} ({{ product.specification or '无规格' }})
                </option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" class="form-control quantity-input" name="quantity[]" 
                   value="1" min="1" step="1" required>
        </td>
        <td>
            <input type="number" class="form-control price-input" name="unit_price[]" 
                   value="0" min="0" step="0.01" required>
        </td>
        <td>
            <input type="number" class="form-control amount-input" name="amount[]" 
                   value="0" readonly>
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeProductRow(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;

        tbody.appendChild(newRow);

        // 绑定事件
        bindRowEvents(newRow);
    }

    function removeProductRow(button) {
        const row = button.closest('tr');
        row.remove();
        calculateTotal();
    }

    function bindRowEvents(row) {
        const productSelect = row.querySelector('.product-select');
        const quantityInput = row.querySelector('.quantity-input');
        const priceInput = row.querySelector('.price-input');

        productSelect.addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const suggestedPrice = selectedOption.getAttribute('data-price') || 0;
            priceInput.value = suggestedPrice;
            calculateRowAmount(row);
        });

        quantityInput.addEventListener('input', function () {
            calculateRowAmount(row);
        });

        priceInput.addEventListener('input', function () {
            calculateRowAmount(row);
        });
    }

    function calculateRowAmount(row) {
        const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
        const price = parseFloat(row.querySelector('.price-input').value) || 0;
        const amount = quantity * price;

        row.querySelector('.amount-input').value = amount.toFixed(2);
        calculateTotal();
    }

    function calculateTotal() {
        let total = 0;
        document.querySelectorAll('.amount-input').forEach(function (input) {
            total += parseFloat(input.value) || 0;
        });

        document.getElementById('form-total').textContent = total.toFixed(2);
        document.getElementById('total-amount').textContent = total.toFixed(2);
    }

    // 页面加载完成后绑定事件
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('#products-table tbody tr').forEach(function (row) {
            bindRowEvents(row);
        });
    });
</script>
{% endblock %}